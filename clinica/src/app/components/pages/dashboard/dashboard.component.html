<div class="dashboard">

    <section class="dashboard__stats-grid animate-fade-in-down">

        <article *ngIf="listaAlertas.length > 0" (click)="abrirModalPrecios()"
            class="card card--interactive dashboard__stat-card dashboard__stat-card--alert">
            <div>
                <p class="dashboard__stat-label">Precios</p>
                <div class="dashboard__stat-value">{{ listaAlertas.length }}</div>
                <div class="dashboard__stat-helper">Requieren revisión</div>
            </div>
            <div class="dashboard__stat-icon">
                <i class="fas fa-exclamation"></i>
            </div>
        </article>

        <article *ngIf="listaAlertas.length === 0" class="card dashboard__stat-card dashboard__stat-card--success">
            <div>
                <p class="dashboard__stat-label">Precios</p>
                <div class="dashboard__stat-value">OK</div>
            </div>
            <div class="dashboard__stat-icon">
                <i class="fas fa-check"></i>
            </div>
        </article>

        <article *ngIf="listaStockBajo.length > 0" (click)="abrirModalStock()"
            class="card card--interactive dashboard__stat-card dashboard__stat-card--warning">
            <div>
                <p class="dashboard__stat-label">Stock Bajo</p>
                <div class="dashboard__stat-value">{{ listaStockBajo.length }}</div>
                <div class="dashboard__stat-helper">Items críticos</div>
            </div>
            <div class="dashboard__stat-icon">
                <i class="fas fa-box-open"></i>
            </div>
        </article>

        <article *ngIf="listaStockBajo.length === 0" class="card dashboard__stat-card dashboard__stat-card--info">
            <div>
                <p class="dashboard__stat-label">Inventario</p>
                <div class="dashboard__stat-value">OK</div>
            </div>
            <div class="dashboard__stat-icon">
                <i class="fas fa-clipboard-check"></i>
            </div>
        </article>

        <article class="card dashboard__stat-card dashboard__stat-card--sales">
            <div>
                <p class="dashboard__stat-label">Ventas Hoy</p>
                <div class="dashboard__stat-value dashboard__stat-value--accent">${{ kpiVentas?.venta_hoy || 0 | number:'1.2-2' }}</div>
                <div class="dashboard__stat-trend">
                    <i *ngIf="kpiVentas?.venta_hoy >= kpiVentas?.venta_ayer" class="fas fa-arrow-up"></i>
                    <i *ngIf="kpiVentas?.venta_hoy < kpiVentas?.venta_ayer" class="fas fa-arrow-down"></i>
                    vs Ayer: ${{ kpiVentas?.venta_ayer }}
                </div>
            </div>
            <div class="dashboard__stat-icon">
                <i class="fas fa-wallet"></i>
            </div>
        </article>

        <article *ngIf="listaSinMovimiento.length > 0" (click)="abrirModalSinMovimiento()"
            class="card card--interactive dashboard__stat-card dashboard__stat-card--secondary">
            <div>
                <p class="dashboard__stat-label">Estancados</p>
                <div class="dashboard__stat-value">{{ listaSinMovimiento.length }}</div>
                <div class="dashboard__stat-helper">+30 días sin venta</div>
            </div>
            <div class="dashboard__stat-icon">
                <i class="fas fa-hourglass-half"></i>
            </div>
        </article>

        <article *ngIf="listaSinMovimiento.length === 0" class="card dashboard__stat-card dashboard__stat-card--neutral">
            <div>
                <p class="dashboard__stat-label">Rotación</p>
                <div class="dashboard__stat-value">100%</div>
            </div>
            <div class="dashboard__stat-icon">
                <i class="fas fa-sync"></i>
            </div>
        </article>

    </section>


    <section class="dashboard__charts-grid animate-fade-in-down">
        
        <article class="card dashboard__chart-card">
            <div class="dashboard__chart-header">
                <h3 class="dashboard__chart-title">Evolución de Ventas</h3>
                <div class="dashboard__range">
                    <button type="button" class="dashboard__range-btn" [ngClass]="{ 'dashboard__range-btn--active': rangoSeleccionado === 7 }" (click)="cambiarRango(7)">7D</button>
                    <button type="button" class="dashboard__range-btn" [ngClass]="{ 'dashboard__range-btn--active': rangoSeleccionado === 15 }" (click)="cambiarRango(15)">15D</button>
                    <button type="button" class="dashboard__range-btn" [ngClass]="{ 'dashboard__range-btn--active': rangoSeleccionado === 30 }" (click)="cambiarRango(30)">30D</button>
                </div>
            </div>
            <div class="dashboard__chart-body">
                <canvas baseChart [data]="lineChartData" [options]="lineChartOptions" [type]="'line'"></canvas>
            </div>
        </article>

        <article class="card dashboard__chart-card">
            <h3 class="dashboard__chart-title">Top 5 Productos Más Vendidos</h3>
            <div class="dashboard__chart-body">
                <canvas baseChart [data]="barChartData" [options]="barChartOptions" [type]="'bar'"></canvas>
            </div>
        </article>

        <article class="card dashboard__chart-card">
            <h3 class="dashboard__chart-title">Balance del Mes</h3>
            <div class="dashboard__chart-body">
                <canvas baseChart [data]="doughnutChartData" [options]="doughnutChartOptions" [type]="'doughnut'"></canvas>
            </div>
            <div class="dashboard__chart-note">
                Comparativa de Ingresos por ventas vs Egresos por compras.
            </div>
        </article>

    </section>


    <div class="modal fade animate-pop-in" id="modalPreciosBootstrap" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content dashboard__modal">
                
                <div class="modal-header dashboard__modal-header">
                    <h5 class="modal-title d-flex align-items-center">
                        <i class="fas fa-hand-holding-usd me-2"></i>
                        Ajuste de Rentabilidad
                    </h5>
                    <button type="button" class="btn-close" (click)="cerrarModalPrecios()"></button>
                </div>

                <div class="modal-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="sticky-top">
                                <tr>
                                    <th class="ps-4 py-3">Producto</th>
                                    <th class="text-center">Costo</th>
                                    <th class="text-center">Venta actual</th>
                                    <th class="text-center" style="width: 180px;">Nuevo precio</th>
                                    <th class="text-center">Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let item of listaAlertas">
                                    <td class="ps-4 py-3">
                                        <div class="dashboard__table-title">{{ item.prod_nombre }}</div>
                                        <small class="dashboard__table-subtitle">{{ item.prod_codbarra }}</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge badge--danger">
                                            ${{ item.prod_preciocompra | number:'1.2-2' }}
                                        </span>
                                    </td>
                                    <td class="text-center dashboard__price-old">
                                        ${{ item.prod_precioventa | number:'1.2-2' }}
                                    </td>
                                    <td class="text-center">
                                        <div class="dashboard__price-input">
                                            <span>$</span>
                                            <input type="number" [(ngModel)]="item.nuevo_precio">
                                        </div>
                                        <div class="dashboard__price-suggested">
                                            Sugerido: ${{ item.precio_sugerido }}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <button type="button" (click)="guardarPrecioIndividual(item)" class="btn btn--primary btn--icon" title="Guardar">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="modal-footer dashboard__modal-footer">
                    <button type="button" class="btn btn--outline" (click)="cerrarModalPrecios()">Cerrar</button>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade animate-pop-in" id="modalStockBootstrap" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content dashboard__modal">
                
                <div class="modal-header dashboard__modal-header">
                    <h5 class="modal-title d-flex align-items-center">
                        <i class="fas fa-boxes me-2"></i>
                        Reabastecer Inventario
                    </h5>
                    <button type="button" class="btn-close" (click)="cerrarModalStock()"></button>
                </div>

                <div class="modal-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="sticky-top">
                                <tr>
                                    <th class="ps-4 py-3 text-center" style="width: 50px;">
                                        <i class="fas fa-check-square"></i>
                                    </th>
                                    <th class="py-3">Producto</th>
                                    <th class="text-center">Niveles</th>
                                    <th class="text-center">A Comprar</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let item of listaStockBajo" 
                                    class="dashboard__table-row" 
                                    (click)="item.selected = !item.selected"
                                    [class.dashboard__table-row--selected]="item.selected">
                                    
                                    <td class="ps-4 py-3 text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input" type="checkbox" [(ngModel)]="item.selected" (click)="$event.stopPropagation()">
                                        </div>
                                    </td>
                                    
                                    <td>
                                        <div class="dashboard__table-title">{{ item.prod_nombre }}</div>
                                        <small class="dashboard__table-subtitle">{{ item.prod_codbarra }}</small>
                                    </td>
                                    
                                    <td class="text-center">
                                        <span class="dashboard__stock-critical">{{ item.prod_stock }}</span>
                                        <small class="dashboard__table-subtitle">/ {{ item.prod_stock_minimo }} min</small>
                                    </td>
                                    
                                    <td class="text-center">
                                        <span class="badge badge--primary">
                                            +{{ item.cantidad_sugerida }} un.
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="modal-footer dashboard__modal-footer">
                    <button type="button" class="btn btn--outline" (click)="cerrarModalStock()">Cancelar</button>
                    <button type="button" class="btn btn--warning" (click)="irACompraConItems()">
                        Generar Orden de Compra <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>