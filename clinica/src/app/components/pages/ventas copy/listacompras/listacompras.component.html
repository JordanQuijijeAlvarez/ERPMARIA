<!-- Header Section -->
<div class="compras">
  <!-- Title and Actions Bar -->
  <div class="card compras-header">
    <div class="card__header">
      <h2 class="card__title">
        GESTIÓN DE COMPRAS
      </h2>
      <p class="card__subtitle">Administre las adquisiciones y recepción de productos</p>
    </div>
    
    <!-- Search and Actions -->
    <div class="compras-header__search">
      <!-- Search Input -->
      <div class="search-box">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="onSearch($any($event.target).value)"
          placeholder="Buscar por proveedor, factura, fecha..."
          class="search-box__input"
        />
        <div class="search-box__icon">
          <i class="fas fa-search"></i>
        </div>
        
        <!-- Clear search button -->
        <button
          *ngIf="isSearching"
          type="button"
          (click)="clearSearch()"
          title="Limpiar búsqueda"
          class="search-box__clear"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Compras Table -->
  <div class="table-container compras-table">
    <div class="table-header">
      <div class="compras-table__header">
        <h3 class="table-header__title">
          <i class="fas fa-shopping-cart"></i>
          Compras Registradas
        </h3>
        
        <!-- Search indicator -->
        <div *ngIf="isSearching" class="badge badge--info">
          <i class="fas fa-search"></i>
          <span>{{ filteredCompras.length }} resultado(s) para "{{ searchTerm }}"</span>
          <button 
            (click)="clearSearch()"
            title="Limpiar búsqueda"
            class="search-box__clear compras-search-badge"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <!-- New Compra Button -->
      <a routerLink="../crearCompra">
        <button type="button" class="btn btn--primary">
          <i class="fas fa-cart-plus"></i>
          <span>Nueva Compra</span>
        </button>
      </a>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button
        (click)="cambiarTab(1)"
        [class.active]="estadoActual === 1"
        class="tabs__button"
      >
        <i class="fas fa-check-circle"></i> Activas
      </button>
      <button
        (click)="cambiarTab(0)"
        [class.active]="estadoActual === 0"
        class="tabs__button"
      >
        <i class="fas fa-ban"></i> Anuladas
      </button>
    </div>

    
    <div>
      <table class="table">
        <thead>
          <tr>
            <th>
              <i class="fas fa-hashtag"></i>
              ID
            </th>
            <th>
              <i class="fas fa-truck"></i>
              Proveedor
            </th>
            <th>
              <i class="fas fa-calendar"></i>
              Fecha
            </th>
            <th>
              <i class="fas fa-shipping-fast"></i>
              Estado Entrega
            </th>
            <th>
              <i class="fas fa-dollar-sign"></i>
              Total
            </th>
            <th>
              <i class="fas fa-cogs"></i>
              Acciones
            </th>
          </tr>
        </thead>
        <tbody>
          <!-- No results message -->
          <tr *ngIf="paginatedCompras.length === 0">
            <td colspan="6">
              <div class="table__empty">
                <div class="table__empty-icon">
                  <i class="fas fa-inbox" *ngIf="!isSearching"></i>
                  <i class="fas fa-search" *ngIf="isSearching"></i>
                </div>
                <div>
                  <p *ngIf="isSearching"><strong>No se encontraron compras</strong></p>
                  <p *ngIf="!isSearching"><strong>No hay compras registradas</strong></p>
                  <p>
                    {{ estadoActual === 1 ? 'No hay compras activas en el sistema' : 'No hay compras anuladas' }}
                  </p>
                </div>
              </div>
            </td>
          </tr>
              
              <tr *ngFor="let compra of paginatedCompras" class="hover:bg-gray-50 transition-colors duration-200">

                <td class="px-3 py-3 whitespace-nowrap font-medium">
                  #{{ compra.compra_id }}
                </td>

                <td class="px-3 py-3 whitespace-nowrap">
                  {{ compra.prove_nombre }} 
                </td>

                <td class="px-3 py-3 whitespace-nowrap">
                  {{ compra.compra_horafecha | date:'dd/MM/yyyy HH:mm' }}
                </td>

                <td class="px-3 py-3 whitespace-nowrap text-center">
                    <span *ngIf="compra.compra_estadoregistro === 'P'" 
                          class="px-2 py-1 text-xs font-semibold text-yellow-700 bg-yellow-100 rounded-full">
                      <i class="fas fa-clock mr-1"></i> Pendiente
                    </span>
                    <span *ngIf="compra.compra_estadoregistro === 'R'" 
                          class="px-2 py-1 text-xs font-semibold text-green-700 bg-green-100 rounded-full">
                      <i class="fas fa-check-double mr-1"></i> Recibido
                    </span>
                </td>

                <td class="px-3 py-3 whitespace-nowrap text-right font-semibold">
                  {{ compra.compra_montototal | currency:'USD' }}
                </td>

                <td class="px-3 py-3 whitespace-nowrap text-center">
                  <div class="flex justify-center gap-2">

                    <button (click)="verDetalle(compra.compra_id, compra.compra_montototal, compra.compra_iva)"
                      class="w-8 h-8 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200" title="Ver detalle">
                      <i class="fas fa-eye text-xs"></i>
                    </button>

                    <ng-container *ngIf="estadoActual === 1">
                      
                      <button *ngIf="compra.compra_estadoregistro === 'P'"
                        (click)="confirmarRecepcion(compra.compra_id)"
                        class="w-8 h-8 bg-green-100 text-green-600 rounded-lg hover:bg-green-200" 
                        title="Confirmar Recepción de Mercadería">
                        <i class="fas fa-box-open text-xs"></i>
                      </button>

                      <button *ngIf="compra.compra_estadoregistro === 'P'"
                        (click)="ActualizarCompra(compra.compra_id)"
                        class="w-8 h-8 bg-yellow-100 text-yellow-600 rounded-lg hover:bg-yellow-200" title="Editar">
                        <i class="fas fa-edit text-xs"></i>
                      </button>

                      <button (click)="anularCompra(compra.compra_id)"
                        class="w-8 h-8 bg-red-100 text-red-600 rounded-lg hover:bg-red-200" title="Anular">
                        <i class="fas fa-trash text-xs"></i>
                      </button>
                    </ng-container>

                <!-- Cancelled indicator -->
                <span *ngIf="estadoActual === 0" class="badge badge--danger">
                  Anulada
                </span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination Section -->
    <div *ngIf="totalItems > 0" class="pagination">
      <!-- Results info y selector de items por página -->
      <div class="pagination__info">
        <div class="pagination__text">
          Mostrando <span>{{ getItemRange().start }}-{{ getItemRange().end }}</span> de <span>{{ totalItems }}</span> compras
        </div>
        
        <!-- Selector de items por página -->
        <div class="pagination__select-wrapper">
          <label for="itemsPerPage">Mostrar:</label>
          <select 
            id="itemsPerPage"
            (change)="changeItemsPerPage(+$any($event.target).value)"
            [value]="itemsPerPage"
            class="pagination__select"
          >
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <span>por página</span>
        </div>
      </div>
      
      <!-- Pagination controls -->
      <div class="pagination__controls">
        <button
          type="button"
          (click)="previousPage()"
          [disabled]="currentPage === 1"
          class="pagination__button"
        >
          <i class="fas fa-chevron-left"></i>
          Anterior
        </button>
        
        <div class="pagination__numbers">
          <button
            *ngFor="let page of getPageNumbers()"
            type="button"
            (click)="goToPage(page)"
            [class.pagination__number--active]="page === currentPage"
            class="pagination__number"
          >
            {{ page }}
          </button>
          
          <!-- Ellipsis for large page counts -->
          <span *ngIf="totalPages > 5 && currentPage < totalPages - 2">...</span>
        </div>
        
        <button
          type="button"
          (click)="nextPage()"
          [disabled]="currentPage === totalPages"
          class="pagination__button"
        >
          Siguiente
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Modal for Compra Detail -->
  <div *ngIf="mostrarDetalle" class="modal">
    <div class="modal__overlay" (click)="cerrarDetalle()"></div>
    <div class="modal__content modal__content--large">
      <div class="modal__header">
        <h3 class="modal__title">
          <i class="fas fa-file-invoice-dollar"></i>
          Detalle de Compra #{{ compraSeleccionadaId }}
        </h3>
        <button 
          (click)="cerrarDetalle()"
          class="modal__close"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal__body">
        <table class="table">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Costo Unit.</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let det of detalleCompra">
              <td>{{ det.prod_nombre }}</td>
              <td>{{ det.detc_cantidad }}</td>
              <td>{{ det.prod_preciocompra | currency:'USD' }}</td>
              <td>{{ det.detc_subtotal | currency:'USD' }}</td>
            </tr>
          </tbody>
        </table>
        
        <div class="compras-modal__totals">
          <div class="compras-modal__total-row">
            <p class="compras-modal__total-label">Subtotal</p>
            <p class="compras-modal__total-value">{{ subtiva | currency:'USD' }}</p>
          </div>
          <div class="compras-modal__total-row">
            <p class="compras-modal__total-label">IVA</p>
            <p class="compras-modal__total-value">{{ iva | currency:'USD' }}</p>
          </div>
          <div class="compras-modal__total-row compras-modal__total-row--final">
            <p class="compras-modal__total-label">Total</p>
            <p class="compras-modal__total-value">{{ totalDetalle | currency:'USD' }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>