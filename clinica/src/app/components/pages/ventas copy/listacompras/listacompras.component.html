<div class="compras">
  <div class="card compras-header">
    <div class="card__header">
      <h2 class="card__title">GESTIÓN DE COMPRAS</h2>
      <p class="card__subtitle">Administre las adquisiciones y recepción de productos</p>
    </div>
    
    <div class="compras-header__search">
      <div class="search-box">
        <input type="text" [(ngModel)]="searchTerm" (input)="onSearch($any($event.target).value)"
          placeholder="Buscar por proveedor, ID..." class="search-box__input" />
        <div class="search-box__icon"><i class="fas fa-search"></i></div>
        <button *ngIf="isSearching" type="button" (click)="clearSearch()" class="search-box__clear">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="table-container compras-table">
    <div class="table-header">
      <div class="compras-table__header">
        <h3 class="table-header__title"><i class="fas fa-shopping-cart"></i> Compras Registradas</h3>
        <div *ngIf="isSearching" class="badge badge--info">
          <i class="fas fa-search"></i>
          <span>{{ filteredCompras.length }} resultado(s)</span>
        </div>
      </div>
      <a routerLink="../crearCompra">
        <button class="btn btn--primary"><i class="fas fa-cart-plus"></i> Nueva Compra</button>
      </a>
    </div>

    <div class="tabs">
      <ul class="tabs__list">
        <li class="tabs__item">
          <button class="tabs__button" [class.tabs__button--active]="estadoActual === 1" (click)="cambiarTab(1)">
            <i class="fas fa-check-circle"></i> Activas
          </button>
        </li>
        <li class="tabs__item">
          <button class="tabs__button" [class.tabs__button--active]="estadoActual === 0" (click)="cambiarTab(0)">
            <i class="fas fa-ban"></i> Anuladas
          </button>
        </li>
      </ul>
    </div>

    <div>
      <table class="table">
        <thead>
          <tr>
            <th><i class="fas fa-hashtag"></i> ID</th>
            <th><i class="fas fa-truck"></i> Proveedor</th>
            <th><i class="fas fa-calendar"></i> Fecha</th>
            <th><i class="fas fa-info-circle"></i> Estado</th>
            <th><i class="fas fa-dollar-sign"></i> Total</th>
            <th><i class="fas fa-cogs"></i> Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="paginatedCompras.length === 0">
            <td colspan="6">
              <div class="table__empty">
                <div class="table__empty-icon">
                  <i class="fas fa-inbox"></i>
                </div>
                <p>No se encontraron compras registradas.</p>
              </div>
            </td>
          </tr>

          <tr *ngFor="let compra of paginatedCompras">
            <td>#{{ compra.compra_id || compra.COMPRA_ID }}</td>
            <td>{{ compra.prove_nombre || compra.PROVE_NOMBRE }}</td>
            <td>{{ (compra.compra_horafecha || compra.COMPRA_HORAFECHA) | date:'dd/MM/yyyy HH:mm' }}</td>
            <td>
              <span [ngClass]="(compra.compra_estadoregistro === 'R' || compra.COMPRA_ESTADOREGISTRO === 'R') ? 'badge--success' : 'badge--warning'" class="badge">
                {{ (compra.compra_estadoregistro === 'R' || compra.COMPRA_ESTADOREGISTRO === 'R') ? 'Recibido' : 'Pendiente' }}
              </span>
            </td>
            <td class="text-right font-bold">
              {{ (compra.compra_montototal || compra.COMPRA_TOTAL) | currency:'USD' }}
            </td>
            <td>
              <div class="table__actions">
                <button (click)="verDetalle(compra.compra_id || compra.COMPRA_ID, compra.compra_montototal || compra.COMPRA_TOTAL, compra.compra_iva || compra.COMPRA_IVA)"
                  class="btn btn--info btn--sm btn--icon" title="Ver Detalle">
                  <i class="fas fa-eye"></i>
                </button>

                <button (click)="descargarFactura(compra)" class="btn btn--secondary btn--sm btn--icon" title="PDF">
                  <i class="fas fa-file-pdf"></i>
                </button>
                
                <ng-container *ngIf="estadoActual === 1">
                  <button *ngIf="(compra.compra_estadoregistro === 'P' || compra.COMPRA_ESTADOREGISTRO === 'P')" 
                          (click)="confirmarRecepcion(compra.compra_id || compra.COMPRA_ID)" 
                          class="btn btn--success btn--sm btn--icon" title="Recibir Mercadería">
                    <i class="fas fa-box-open"></i>
                  </button>

                  <button *ngIf="(compra.compra_estadoregistro === 'P' || compra.COMPRA_ESTADOREGISTRO === 'P')" 
                          (click)="ActualizarCompra(compra.compra_id || compra.COMPRA_ID)" 
                          class="btn btn--warning btn--sm btn--icon" title="Editar">
                    <i class="fas fa-pen"></i>
                  </button>

                  <button (click)="anularCompra(compra.compra_id || compra.COMPRA_ID)" class="btn btn--danger btn--sm btn--icon" title="Anular">
                    <i class="fas fa-trash"></i>
                  </button>
                </ng-container>

                <span class="badge badge--danger" *ngIf="estadoActual === 0">Anulada</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination" *ngIf="totalItems > 0">
      <div class="pagination__info">Mostrando {{ getItemRange().start }}-{{ getItemRange().end }} de {{ totalItems }}</div>
      <div class="pagination__controls">
        <button (click)="previousPage()" [disabled]="currentPage === 1" class="pagination__button">Anterior</button>
        <button (click)="nextPage()" [disabled]="currentPage === totalPages" class="pagination__button">Siguiente</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" *ngIf="mostrarDetalle">
  <div class="modal__overlay" (click)="cerrarDetalle()"></div> <div class="modal__content">
    <div class="modal__header">
      <h3 class="modal__title">
        <i class="fas fa-file-invoice-dollar"></i> Detalle de Compra #{{ compraSeleccionadaId }}
      </h3>
      <button class="modal__close" (click)="cerrarDetalle()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal__body">
      <table class="table">
        <thead>
          <tr>
            <th>Producto</th>
            <th class="text-center">Cant.</th>
            <th class="text-right">Costo Unit.</th>
            <th class="text-right">Subtotal</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let det of detalleCompra">
            <td>{{ det.prod_nombre || det.PROD_NOMBRE }}</td>
            <td class="text-center">{{ det.detc_cantidad || det.DETC_CANTIDAD }}</td>
            <td class="text-right">{{ (det.detc_preciouni || det.DETC_PRECIOUNI) | currency:'USD' }}</td>
            <td class="text-right">{{ (det.detc_subtotal || det.DETC_SUBTOTAL) | currency:'USD' }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="modal__footer">
      <div class="modal__totals">
        <div class="modal__total-item">
          <span>Subtotal:</span>
          <span>{{ subtiva | currency:'USD' }}</span>
        </div>
        <div class="modal__total-item">
          <span>IVA:</span>
          <span>{{ iva | currency:'USD' }}</span>
        </div>
        <div class="modal__total-item modal__total-item--highlight">
          <span>Total:</span>
          <span>{{ totalDetalle | currency:'USD' }}</span>
        </div>
      </div>
    </div>
  </div>
</div>