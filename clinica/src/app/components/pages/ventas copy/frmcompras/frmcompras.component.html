<form [formGroup]="formCompras" (ngSubmit)="guardarCompra()" class="compra-form">
  <div>
    <div class="card">
      <div>
        
        <div class="compra-form__header">
          <h2 class="compra-form__title">
            {{ eventoUpdate ? "EDITAR ORDEN DE COMPRA" : "NUEVA ORDEN DE COMPRA" }}
          </h2>
          <p class="compra-form__subtitle">
            Busque el proveedor y agregue los productos a la orden de compra
          </p>
        </div>

        <div class="compra-form__section-header">
          <h3 class="compra-form__section-title">
            <i class="fas fa-truck"></i> Información del Proveedor
          </h3>
        </div>

        <div class="compra-form__fields">
          <div class="compra-form__field">
            <label> <i class="fas fa-id-card"></i> Buscar Proveedor (RUC o Nombre) * </label>
            
            <div class="compra-form__search-group" style="position: relative;">
              <input
                formControlName="txtRucProveedor"
                placeholder="Escriba para buscar..."
                type="text"
                autocomplete="off"
                (input)="filtrarProveedores($any($event.target).value); validarLimpiezaProveedor($any($event.target).value)"
                (blur)="cerrarDropdownProveedor()"
                (focus)="filtrarProveedores(getRucProveedor.value)"
                (keydown.enter)="$event.preventDefault(); buscarProveedorManual()"
              />
              
              <button type="button" class="compra-form__search-btn" (click)="buscarProveedorManual()">
                 <i class="fas fa-search"></i>
              </button>
          
              <div *ngIf="mostrarDropdownProveedor" class="dropdown-proveedores shadow-lg">
                <ul>
                  <li *ngFor="let prov of listaProveedoresFiltrados" (mousedown)="seleccionarProveedor(prov)">
                    <div class="flex justify-between items-center w-full">
                      <span class="prov-nombre">{{ prov.prove_nombre }}</span>
                      <span class="prov-ruc badge">{{ prov.prove_ruc }}</span>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <div class="compra-form__field">
            <label> <i class="fas fa-building"></i> Razón Social </label>
            <input readonly formControlName="txtNombreProveedor" placeholder="Nombre..." />
          </div>

          <div class="compra-form__field">
            <label> <i class="fas fa-map-marker-alt"></i> Datos Adicionales </label>
            <input readonly formControlName="txtDatosAdicionales" placeholder="Contacto..." />
          </div>
        </div>

        <div class="compra-form__section-header">
          <h3 class="compra-form__section-title">
            <i class="fas fa-boxes"></i> Agregar Productos
          </h3>
        </div>

        <div class="compra-form__product-search">
          <div class="compra-form__field">
            <label> Buscar Producto (Código o Nombre) </label>
            
            <div class="compra-form__search-input-wrapper" style="position: relative;">
              <i class="fas fa-search"></i>
              <input
                type="text"
                formControlName="txtCodBarra"
                placeholder="Escanee código o escriba nombre..."
                autocomplete="off"
                (input)="filtrarProductos($any($event.target).value)"
                (blur)="cerrarDropdownProducto()"
                (keydown.enter)="$event.preventDefault(); agregarProductoManual()"
              />

              <div *ngIf="mostrarDropdownProducto" class="dropdown-proveedores shadow-lg" style="top: 100%; left: 0; width: 100%;">
                <ul>
                  <li *ngFor="let prod of listaProductosFiltrados" (mousedown)="seleccionarProducto(prod)">
                    <div class="flex flex-col w-full">
                      <span class="prov-nombre">{{ prod.prod_nombre }}</span>
                      <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span><i class="fas fa-barcode"></i> {{ prod.prod_codbarra }}</span>
                        <span class="font-bold text-blue-600">Stock: {{ prod.prod_stock }}</span>
                      </div>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <div class="compra-form__field">
            <label> Stock Actual </label>
            <div class="compra-form__stock-display">
              {{ stockActual || 0 }}
            </div>
          </div>

          <div class="compra-form__field">
            <label>&nbsp;</label>
            <button type="button" class="compra-form__action-btn compra-form__action-btn--add" (click)="agregarProductoManual()">
              <i class="fas fa-plus"></i> Agregar
            </button>
          </div>
        </div>

        <div class="compra-form__table-wrapper">
          <table class="compra-form__table">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Costo Unit.</th>
                <th>Cantidad</th>
                <th>Subtotal</th>
                <th>Acción</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of listaDetalles; let i = index">
                <td>
                  <div class="compra-form__product-name">{{ item.nombreProducto }}</div>
                  <div class="compra-form__product-code">{{ item.codigo }}</div>
                </td>

                <td class="text-center">
                  <input type="number" 
                         [(ngModel)]="item.precioCompra" 
                         [ngModelOptions]="{standalone: true}"
                         (input)="actualizarPrecioUnitario(i)"
                         class="w-24 border rounded p-1 text-center font-bold" 
                         min="0" step="0.01">
                </td>

                <td>
                  <div class="compra-form__quantity-controls">
                    <button type="button" class="compra-form__quantity-btn" (click)="disminuirCantidad(i)">
                      <i class="fas fa-minus"></i>
                    </button>
                    <input
                      type="number"
                      class="compra-form__quantity-input"
                      [(ngModel)]="item.cantidad"
                      [ngModelOptions]="{ standalone: true }"
                      (change)="actualizarPrecioUnitario(i)"
                    />
                    <button type="button" class="compra-form__quantity-btn" (click)="aumentarCantidad(i)">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                </td>

                <td>${{ item.subtotal | number : "1.2-2" }}</td>

                <td>
                  <button type="button" class="compra-form__action-btn compra-form__action-btn--delete" (click)="eliminarProducto(i)">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </td>
              </tr>

              <tr *ngIf="listaDetalles.length === 0">
                <td colspan="5">
                  <div class="compra-form__empty-state">
                    <div class="compra-form__empty-icon"><i class="fas fa-clipboard-list"></i></div>
                    <div class="compra-form__empty-text">No hay productos agregados.</div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="compra-form__totals">
          <div class="compra-form__totals-card">
            <div>
              <div class="compra-form__total-row">
                <span>Subtotal:</span>
                <span>${{ subtotal | number : "1.2-2" }}</span>
              </div>
              <div class="compra-form__total-row">
                <span>IVA ({{ ivaPorcentaje }}%):</span>
                <span>${{ iva | number : "1.2-2" }}</span>
              </div>
              <div class="compra-form__total-divider"></div>
              <div class="compra-form__total-row compra-form__total-row--final">
                <span>TOTAL:</span>
                <span>${{ total | number : "1.2-2" }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="compra-form__actions">
        <button type="button" class="compra-form__btn compra-form__btn--cancel" (click)="cancelarCompra()">
          <i class="fas fa-times"></i> Cancelar
        </button>

        <button type="submit" class="compra-form__btn compra-form__btn--submit" [disabled]="listaDetalles.length === 0">
          <i class="fas fa-save"></i> Registrar Orden
        </button>
      </div>
    </div>
  </div>
</form>