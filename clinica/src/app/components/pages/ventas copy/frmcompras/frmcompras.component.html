<form [formGroup]="formCompras" (ngSubmit)="guardarCompra()" class="compra-form">
  <div>
    <div class="card">
      <div>
        <div class="compra-form__header">
          <h2 class="compra-form__title">
            {{
              eventoUpdate ? "EDITAR ORDEN DE COMPRA" : "NUEVA ORDEN DE COMPRA"
            }}
          </h2>
          <p class="compra-form__subtitle">
            Busque el proveedor y agregue los productos a la orden de compra
          </p>
        </div>

        <div class="compra-form__section-header">
          <h3 class="compra-form__section-title">
            <i class="fas fa-truck"></i>
            Información del Proveedor
          </h3>
        </div>

        <div class="compra-form__fields">
          <div class="compra-form__field">
            <label> <i class="fas fa-id-card"></i> RUC Proveedor * </label>
            <div class="compra-form__search-group">
              <input
                formControlName="txtRucProveedor"
                placeholder="Buscar RUC..."
                type="text"
                (keydown.enter)="$event.preventDefault(); buscarProveedor()"
              />
              <button
                type="button"
                class="compra-form__search-btn"
                (click)="buscarProveedor()"
                title="Buscar Proveedor"
              >
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>

          <div class="compra-form__field">
            <label>
              <i class="fas fa-building"></i> Razón Social / Nombre
            </label>
            <input
              readonly
              formControlName="txtNombreProveedor"
              placeholder="Nombre del proveedor..."
            />
          </div>

          <div class="compra-form__field">
            <label>
              <i class="fas fa-map-marker-alt"></i> Dirección / Teléfono
            </label>
            <input
              readonly
              formControlName="txtDatosAdicionales"
              placeholder="Información de contacto..."
            />
          </div>
        </div>

        <div class="compra-form__section-header">
          <h3 class="compra-form__section-title">
            <i class="fas fa-boxes"></i>
            Agregar Productos a la Orden
          </h3>
        </div>

        <div class="compra-form__product-search">
          <div class="compra-form__field">
            <label> Buscar Producto (Catálogo) </label>
            <div class="compra-form__search-input-wrapper">
              <i class="fas fa-search"></i>
              <input
                type="text"
                formControlName="txtCodBarra"
                (keydown.enter)="$event.preventDefault(); agregarProducto()"
                placeholder="Escriba código de barras o nombre del producto..."
              />
            </div>
          </div>

          <div class="compra-form__field">
            <label> Stock Actual </label>
            <div class="compra-form__stock-display">
              {{ stockActual || 0 }}
            </div>
          </div>

          <div class="compra-form__field">
            <label>&nbsp;</label>
            <button type="button" class="compra-form__action-btn compra-form__action-btn--add" (click)="agregarProducto()">
              <i class="fas fa-plus"></i> Agregar
            </button>
          </div>
        </div>

        <div class="compra-form__table-wrapper">
          <table class="compra-form__table">
            <thead>
              <tr>
                <th>
                  <i class="fas fa-box"></i>
                  Producto
                </th>
                <th>
                  <i class="fas fa-dollar-sign"></i>
                  Costo Unit.
                </th>
                <th>
                  <i class="fas fa-sort-numeric-up"></i>
                  Cantidad
                </th>
                <th>
                  <i class="fas fa-calculator"></i>
                  Subtotal
                </th>
                <th>
                  <i class="fas fa-cogs"></i>
                  Acción
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of listaDetalles; let i = index">
                <td>
                  <div class="compra-form__product-name">{{ item.nombreProducto }}</div>
                  <div class="compra-form__product-code">{{ item.codigo }}</div>
                </td>

                <td class="compra-form__product-price">
                  ${{ item.precioCompra | number : "1.2-2" }}
                </td>

                <td>
                  <div class="compra-form__quantity-controls">
                    <button type="button" class="compra-form__quantity-btn" (click)="disminuirCantidad(i)">
                      <i class="fas fa-minus"></i>
                    </button>
                    <input
                      type="number"
                      class="compra-form__quantity-input"
                      [(ngModel)]="item.cantidad"
                      [ngModelOptions]="{ standalone: true }"
                      (change)="calcularTotales()"
                    />
                    <button type="button" class="compra-form__quantity-btn" (click)="aumentarCantidad(i)">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                </td>

                <td>
                  ${{ item.cantidad * item.precioCompra | number : "1.2-2" }}
                </td>

                <td>
                  <button type="button" class="compra-form__action-btn compra-form__action-btn--delete" (click)="eliminarProducto(i)">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </td>
              </tr>

              <tr *ngIf="listaDetalles.length === 0">
                <td colspan="5">
                  <div class="compra-form__empty-state">
                    <div class="compra-form__empty-icon">
                      <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="compra-form__empty-text">No hay productos agregados a la orden de compra</div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="compra-form__totals">
          <div class="compra-form__totals-card">
            <div>
              <div class="compra-form__total-row">
                <span>Subtotal:</span>
                <span>${{ subtotal | number : "1.2-2" }}</span>
              </div>
              <div class="compra-form__total-row">
                <span>IVA (15%):</span>
                <span>${{ iva | number : "1.2-2" }}</span>
              </div>
              <div class="compra-form__total-divider"></div>
              <div class="compra-form__total-row compra-form__total-row--final">
                <span>TOTAL A PAGAR:</span>
                <span>${{ total | number : "1.2-2" }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="compra-form__actions">
        <button type="button" class="compra-form__btn compra-form__btn--cancel" (click)="cancelarCompra()">
          <i class="fas fa-times"></i>
          Cancelar
        </button>

        <button type="submit" class="compra-form__btn compra-form__btn--submit" [disabled]="listaDetalles.length === 0">
          <i class="fas fa-save"></i>
          Registrar Orden de Compra
        </button>
      </div>
    </div>
  </div>
</form>
