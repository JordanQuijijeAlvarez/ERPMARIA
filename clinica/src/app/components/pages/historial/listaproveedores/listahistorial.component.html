<div class="auditoria-page">
  
  <div class="card auditoria-header">
    <div class="card__header">
      <h2 class="card__title">
        <i class="fas fa-shield-alt"></i> CENTRO DE SEGURIDAD
      </h2>
      <p class="card__subtitle">Monitoreo de auditoría de datos y accesos al sistema</p>
    </div>

    <div class="tabs-container">
      <button 
        class="tab-btn" 
        [class.active]="activeTab === 'cambios'"
        (click)="switchTab('cambios')">
        <i class="fas fa-database"></i> Auditoría de Datos
      </button>
      <button 
        class="tab-btn" 
        [class.active]="activeTab === 'accesos'"
        (click)="switchTab('accesos')">
        <i class="fas fa-key"></i> Historial de Accesos
      </button>
    </div>

    <div class="auditoria-filters" *ngIf="activeTab === 'cambios'">
      
      <div class="filter-box">
        <select 
          [(ngModel)]="filterOperacion" 
          (change)="onSearch()"
          class="search-box__input filter-select">
          <option value="">Todas las Operaciones</option>
          <option value="INSERT">Creación (INSERT)</option>
          <option value="UPDATE">Modificación (UPDATE)</option>
          <option value="DELETE">Eliminación (DELETE)</option>
        </select>
      </div>

      <div class="filter-box">
        <select 
          [(ngModel)]="filterTabla" 
          (change)="onSearch()"
          class="search-box__input filter-select">
          <option value="">Todas las Tablas</option>
          <option value="PRODUCTO">Productos</option>
          <option value="VENTA">Ventas</option>
          <option value="USUARIO">Usuarios</option>
          <option value="PROVEEDOR">Proveedores</option>
          <option value="CLIENTE">Clientes</option>
        </select>
      </div>

      <div class="search-box">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="onSearch()"
          placeholder="Buscar por usuario, ID..."
          class="search-box__input"
        />
        <div class="search-box__icon">
          <i class="fas fa-search"></i>
        </div>
        
        <button
          *ngIf="searchTerm || filterOperacion || filterTabla"
          type="button"
          (click)="clearFilters()"
          title="Limpiar filtros"
          class="search-box__clear"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="activeTab === 'cambios'" class="table-container auditoria-table fade-in">
    <div class="table-header">
      <div class="proveedores-table__header">
        <h3 class="table-header__title">
          <i class="fas fa-list-alt"></i>
          Registros de Movimientos
        </h3>
        
        <div *ngIf="searchTerm || filterOperacion || filterTabla" class="badge badge--info">
          <i class="fas fa-filter"></i>
          <span>Resultados filtrados: {{ filteredAuditoria.length }}</span>
        </div>
      </div>
    </div>
      
    <div>
      <table class="table">
        <thead>
          <tr>
            <th><i class="fas fa-clock"></i> Fecha/Hora</th>
            <th><i class="fas fa-user"></i> Usuario</th>
            <th><i class="fas fa-exchange-alt"></i> Operación</th>
            <th><i class="fas fa-database"></i> Tabla</th>
            <th><i class="fas fa-fingerprint"></i> ID Ref.</th>
            <th><i class="fas fa-eye"></i> Detalle</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="paginatedAuditoria.length === 0">
            <td colspan="6">
              <div class="table__empty">
                <div class="table__empty-icon">
                  <i class="fas fa-history"></i>
                </div>
                <div>
                  <p><strong>No se encontraron registros</strong></p>
                  <p *ngIf="searchTerm">Intente ajustar los filtros de búsqueda.</p>
                </div>
              </div>
            </td>
          </tr>
          
          <tr *ngFor="let audit of paginatedAuditoria">
            <td>
              <div class="fecha-container">
                <span class="fecha-date">{{ audit.audi_fechregistro | date:'dd/MM/yyyy' }}</span>
                <span class="fecha-time">{{ audit.audi_fechregistro | date:'mediumTime' }}</span>
              </div>
            </td>
            <td>
              <div class="user-info">
                <span class="user-name">{{ audit.usuario_nombre || 'Usuario ID: ' + audit.user_id }}</span>
              </div>
            </td>
            <td>
              <span class="badge-op" [ngClass]="{
                'badge-insert': audit.audi_operacion === 'INSERT',
                'badge-update': audit.audi_operacion === 'UPDATE',
                'badge-delete': audit.audi_operacion === 'DELETE'
              }">
                {{ audit.audi_operacion }}
              </span>
            </td>
            <td><strong>{{ audit.audi_tabla }}</strong></td>
            <td>#{{ audit.audi_registroid }}</td>
            <td>
              <div class="table__actions">
                <button
                  (click)="verDetalles(audit)"
                  type="button"
                  title="Ver detalles del cambio"
                  class="btn btn--primary btn--sm btn--icon"
                >
                  <i class="fas fa-search-plus"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <div *ngIf="totalItems > 0" class="pagination">
      <div class="pagination__info">
        <div class="pagination__text">
          Mostrando {{ getItemRange().start }}-{{ getItemRange().end }} de {{ totalItems }}
        </div>
        <div class="pagination__select-wrapper">
            <select (change)="changeItemsPerPage(+$any($event.target).value)" [value]="itemsPerPage" class="pagination__select">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
          </select>
        </div>
      </div>
      
      <div class="pagination__controls">
        <button type="button" (click)="previousPage()" [disabled]="currentPage === 1" class="pagination__button">
          <i class="fas fa-chevron-left"></i>
        </button>
        <span class="pagination__current">{{currentPage}} / {{totalPages}}</span>
        <button type="button" (click)="nextPage()" [disabled]="currentPage === totalPages" class="pagination__button">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="activeTab === 'accesos'" class="table-container fade-in">
    <div class="table-header">
      <h3 class="table-header__title">
        <i class="fas fa-network-wired"></i> Sesiones Recientes
      </h3>
    </div>

    <table class="table">
      <thead>
        <tr>
          <th>Estado</th>
          <th>Usuario</th>
          <th>IP Origen</th>
          <th>Dispositivo / Navegador</th>
          <th>Inicio de Sesión</th>
          <th>Última Actividad</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngIf="listaSesiones.length === 0">
            <td colspan="6" style="text-align:center; padding: 2rem;">No hay registro de sesiones recientes.</td>
        </tr>
        <tr *ngFor="let sesion of listaSesiones">
          <td>
            <span class="status-dot" 
              [class.online]="sesion.is_active === 1"
              [class.offline]="sesion.is_active === 0">
            </span>
            <span class="status-text">{{ sesion.is_active === 1 ? 'Activo' : 'Cerrado' }}</span>
          </td>
          <td><strong>{{ sesion.usuario_nombre }}</strong></td>
          <td>{{ sesion.ip_address || 'Desconocida' }}</td>
          <td>
            <i class="fas fa-desktop"></i> {{ parseUserAgent(sesion.user_agent) }}
          </td>
          <td>{{ sesion.created_at | date:'dd/MM/yyyy HH:mm' }}</td>
          <td>{{ sesion.last_activity | date:'mediumTime' }}</td>
        </tr>
      </tbody>
    </table>
  </div>

</div>

<div class="modal-overlay" *ngIf="selectedAudit">
  <div class="modal-content">
    <div class="modal-header">
      <h3>
        <i class="fas fa-info-circle"></i> 
        Detalle del Cambio #{{selectedAudit.audi_id}}
      </h3>
      <button (click)="closeModal()" class="close-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="audit-summary">
        <p><strong>Operación:</strong> {{selectedAudit.audi_operacion}} en tabla {{selectedAudit.audi_tabla}}</p>
        <p><strong>Usuario:</strong> {{selectedAudit.usuario_nombre}}</p>
      </div>

      <div class="comparison-view">
        <div class="data-block old">
          <h4><i class="fas fa-history"></i> Valor Anterior</h4>
          <div class="code-wrapper">
             <pre>{{ selectedAudit.audi_datoantig || '(Sin datos previos / Creación)' }}</pre>
          </div>
        </div>
        
        <div class="arrow">
          <i class="fas fa-arrow-right"></i>
        </div>
        
        <div class="data-block new">
          <h4><i class="fas fa-check-circle"></i> Valor Nuevo</h4>
          <div class="code-wrapper">
            <pre>{{ selectedAudit.audi_datonuevo || '(Registro eliminado)' }}</pre>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button (click)="closeModal()" class="btn btn--outline">Cerrar</button>
    </div>
  </div>
</div>