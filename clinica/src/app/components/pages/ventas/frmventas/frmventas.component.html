<form [formGroup]="formVentas" (ngSubmit)="guardarVenta()" class="venta-form">
  <div class="venta-form__container">
    <div class="card">
      <div class="card__body">
        
        <div class="card__header">
          <h2 class="card__title">{{ eventoUpdate ? "EDITAR VENTA" : "NUEVA VENTA" }}</h2>
          <p class="card__subtitle">
            Complete la información del cliente y agregue los productos a la factura
          </p>
        </div>

        <div class="section-header">
          <h3 class="section-header__title">
            <i class="fas fa-user-check"></i> Información del Cliente
          </h3>
        </div>

        <div class="client-section">
          <div class="client-section__grid">
            
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-id-card"></i> Buscar Cliente (Cédula o Nombre) *
              </label>
              
              <div class="search-input-group" style="position: relative;">
                <input
                  formControlName="txtCedulaCliente"
                  class="form-input"
                  placeholder="Escriba cédula o nombre..."
                  type="text"
                  autocomplete="off"
                  (input)="filtrarClientes($any($event.target).value); validarLimpiezaCliente($any($event.target).value)"
                  (blur)="cerrarDropdownCliente()"
                  (focus)="filtrarClientes(getCedulaCliente.value)"
                  (keydown.enter)="$event.preventDefault(); buscarClienteManual()"
                />
                
                <button
                  type="button"
                  class="btn btn--primary"
                  (click)="buscarClienteManual()"
                >
                  <i class="fas fa-search"></i>
                </button>

                <div *ngIf="mostrarDropdownCliente" class="dropdown-proveedores shadow-lg" style="top: 100%; left: 0; width: 100%; z-index: 100;">
                  <ul>
                    <li *ngFor="let cli of listaClientesFiltrados" (mousedown)="seleccionarCliente(cli)">
                      <div class="flex justify-between items-center w-full" style="display: flex; justify-content: space-between; width: 100%;">
                        <span class="prov-nombre" style="font-weight: 600;">{{ cli.client_nombres }}</span>
                        <span class="prov-ruc badge" style="font-size: 0.8rem; background: #e0e7ff; padding: 2px 6px; border-radius: 4px;">{{ cli.client_cedula }}</span>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-user"></i> Nombres del Cliente
              </label>
              <input
                readonly
                formControlName="txtNombreCliente"
                class="form-input"
                placeholder="Nombre del cliente..."
              />
            </div>

            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-map-marker-alt"></i> Dirección / Teléfono
              </label>
              <input
                readonly
                formControlName="txtDatosAdicionales"
                class="form-input"
                placeholder="Información de contacto..."
              />
            </div>
          </div>
        </div>

        <div class="section-header">
          <h3 class="section-header__title">
            <i class="fas fa-box-open"></i> Agregar Productos
          </h3>
        </div>

        <div class="product-search">
          <div class="product-search__grid">
            
            <div class="form-group">
              <label class="form-label"> Buscar Producto (Código o Nombre) </label>
              
              <div class="search-box" style="position: relative;">
                <div class="search-box__icon">
                  <i class="fas fa-search"></i>
                </div>
                <input
                  type="text"
                  formControlName="txtCodBarra"
                  class="form-input search-box__input--with-icon"
                  placeholder="Escriba código o nombre..."
                  autocomplete="off"
                  (input)="filtrarProductos($any($event.target).value)"
                  (blur)="cerrarDropdownProducto()"
                  (keydown.enter)="$event.preventDefault(); agregarProductoManual()"
                />

                <div *ngIf="mostrarDropdownProducto" class="dropdown-proveedores shadow-lg" style="top: 100%; left: 0; width: 100%; z-index: 100;">
                  <ul>
                    <li *ngFor="let prod of listaProductosFiltrados" (mousedown)="seleccionarProducto(prod)">
                      <div style="display: flex; flex-direction: column; width: 100%;">
                        <span class="prov-nombre" style="font-weight: 600;">{{ prod.prod_nombre }}</span>
                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #666; margin-top: 4px;">
                          <span><i class="fas fa-barcode"></i> {{ prod.prod_codbarra }}</span>
                          <span style="font-weight: bold; color: #2563EB;">Stock: {{ prod.prod_stock }}</span>
                        </div>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label"> Stock </label>
              <div class="stock-display">
                {{ stockActual || 0 }}
              </div>
            </div>

            <div class="form-group">
              <button
                type="button"
                class="btn btn--primary btn--add-product"
                (click)="agregarProductoManual()"
              >
                <i class="fas fa-plus"></i> Agregar
              </button>
            </div>
          </div>
        </div>

        <div class="products-table">
          <table class="table">
            <thead>
              <tr>
                <th><i class="fas fa-box"></i> Producto</th>
                <th><i class="fas fa-dollar-sign"></i> Precio Unit.</th>
                <th><i class="fas fa-sort-numeric-up"></i> Cantidad</th>
                <th><i class="fas fa-calculator"></i> Subtotal</th>
                <th><i class="fas fa-cogs"></i> Acción</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of listaDetalles; let i = index">
                <td>
                  <div class="product-name">{{ item.nombreProducto }}</div>
                  <div class="product-code">{{ item.codigo }}</div>
                </td>
                <td class="product-price">
                  ${{ item.precioUnitario | number : "1.2-2" }}
                </td>
                <td>
                  <div class="quantity-control">
                    <button type="button" class="quantity-control__btn" (click)="disminuirCantidad(i)">
                      <i class="fas fa-minus"></i>
                    </button>
                    <input
                      type="number"
                      class="quantity-control__input"
                      [(ngModel)]="item.cantidad"
                      [ngModelOptions]="{ standalone: true }"
                      (change)="calcularTotales()"
                    />
                    <button type="button" class="quantity-control__btn" (click)="aumentarCantidad(i)">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                </td>
                <td class="product-subtotal">
                  ${{ item.subtotal | number : "1.2-2" }}
                </td>
                <td>
                  <button type="button" class="btn btn--sm btn--danger btn--icon" (click)="eliminarProducto(i)">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </td>
              </tr>
              
              <tr *ngIf="listaDetalles.length === 0">
                <td colspan="5" style="text-align: center; padding: 2rem;">
                  <div style="color: #ccc; font-size: 2rem; margin-bottom: 0.5rem;">
                    <i class="fas fa-shopping-cart"></i>
                  </div>
                  <p style="color: #888;">No hay productos agregados a la venta</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="totals-section">
          <div class="totals-section__wrapper">
            <div class="totals-section__content">
              <div class="totals-section__row">
                <span>Subtotal:</span>
                <span>${{ subtotal | number : "1.2-2" }}</span>
              </div>
              <div class="totals-section__row">
                <span>IVA ({{ iva }}%):</span>
                <span>${{ iva | number : "1.2-2" }}</span>
              </div>
              <div class="totals-section__divider"></div>
              <div class="totals-section__row totals-section__row--total">
                <span>TOTAL A PAGAR:</span>
                <span>${{ total | number : "1.2-2" }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card__footer">
        <button type="button" class="btn btn--outline btn--lg" (click)="cancelarVenta()">
          <i class="fas fa-times"></i> Cancelar
        </button>

        <button type="submit" class="btn btn--primary btn--lg" [disabled]="listaDetalles.length === 0">
          <i class="fas fa-save"></i> Generar Venta
        </button>
      </div>
    </div>
  </div>
</form>