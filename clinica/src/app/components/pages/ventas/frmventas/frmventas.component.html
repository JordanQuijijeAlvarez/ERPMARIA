<form [formGroup]="formVentas" (ngSubmit)="guardarVenta()" class="venta-form">
  <div class="venta-form__container">
    <div class="card">
      <div class="card__body">

        <div class="card__header">
          <h2 class="card__title">
            NUEVA VENTA
          </h2>
          <p class="card__subtitle">
            Complete la información del cliente y agregue los productos a la factura
          </p>
        </div>

        <div class="section-header">
          <h3 class="section-header__title">
            <i class="fas fa-user-check"></i>
            Información del Cliente
          </h3>
        </div>

        <div class="client-section">
          <div class="client-section__grid">

            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-id-card"></i> Cédula / RUC *
              </label>
              <div class="search-input-group">
                <input formControlName="txtCedulaCliente" class="form-input" placeholder="Buscar cédula..." type="text"
                  (keydown.enter)="$event.preventDefault(); buscarCliente()" />
                <button type="button" class="btn btn--primary" (click)="buscarCliente()">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-user"></i> Nombres del Cliente
              </label>
              <input readonly formControlName="txtNombreCliente" class="form-input" placeholder="Nombre del cliente..." />
            </div>

            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-map-marker-alt"></i> Dirección / Teléfono
              </label>
              <input readonly formControlName="txtDatosAdicionales" class="form-input" placeholder="Información de contacto..." />
            </div>
          </div>
        </div>

        <div class="section-header">
          <h3 class="section-header__title">
            <i class="fas fa-box-open"></i>
            Agregar Productos
          </h3>
        </div>

        <div class="product-search">
          <div class="product-search__grid">

            <div class="form-group">
              <label class="form-label">
                Buscar Producto
              </label>
              <div class="search-box">
                <div class="search-box__icon">
                  <i class="fas fa-search"></i>
                </div>
                <input type="text" formControlName="txtCodBarra" class="form-input search-box__input--with-icon"
                  (keydown.enter)="$event.preventDefault(); agregarProducto()"
                  placeholder="Escriba código o nombre del producto...">
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">
                Stock
              </label>
              <div class="stock-display">
                {{ stockActual || 0 }}
              </div>
            </div>

            <div class="form-group">
              <button type="button" class="btn btn--success btn--add-product" (click)="agregarProducto()">
                <i class="fas fa-plus"></i> Agregar
              </button>
            </div>
          </div>
        </div>

        <div class="products-table">
          <table class="table">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Precio Unit.</th>
                <th>Cantidad</th>
                <th>Subtotal</th>
                <th>Acción</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of listaDetalles; let i = index">
                <td>
                  <div class="product-name">{{ item.nombreProducto }}</div>
                  <div class="product-code">{{ item.codigo }}</div>
                </td>
                <td class="product-price">
                  ${{ item.precioUnitario | number:'1.2-2' }}
                </td>
                <td>
                  <div class="quantity-control">
                    <button type="button" class="quantity-control__btn" (click)="disminuirCantidad(i)">
                      <i class="fas fa-minus"></i>
                    </button>
                    <input type="number" class="quantity-control__input" [(ngModel)]="item.cantidad" [ngModelOptions]="{standalone: true}"
                      (change)="calcularTotales()">
                    <button type="button" class="quantity-control__btn" (click)="aumentarCantidad(i)">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                </td>
                <td class="product-subtotal">
                  ${{ (item.cantidad * item.precioUnitario) | number:'1.2-2' }}
                </td>
                <td>
                  <button type="button" class="btn btn--sm btn--danger btn--icon" (click)="eliminarProducto(i)">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </td>
              </tr>
              <tr *ngIf="listaDetalles.length === 0">
                <td colspan="5" class="table__empty">
                  <div class="table__empty-icon">
                    <i class="fas fa-shopping-cart"></i>
                  </div>
                  <p>No hay productos agregados a la venta</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="totals-section">
          <div class="totals-section__wrapper">
            <div class="totals-section__content">
              <div class="totals-section__row">
                <span>Subtotal:</span>
                <span>${{ subtotal | number:'1.2-2' }}</span>
              </div>
              <div class="totals-section__row">
                <span>IVA (15%):</span>
                <span>${{ iva | number:'1.2-2' }}</span>
              </div>
              <div class="totals-section__divider"></div>
              <div class="totals-section__row totals-section__row--total">
                <span>TOTAL A PAGAR:</span>
                <span>${{ total | number:'1.2-2' }}</span>
              </div>
            </div>
          </div>
        </div>

      </div>

      <div class="card__footer">
        <button type="button" class="btn btn--outline btn--lg" (click)="cancelarVenta()">
          <i class="fas fa-times"></i>
          Cancelar
        </button>

        <button type="submit" class="btn btn--success btn--lg" [disabled]="listaDetalles.length === 0">
          <i class="fas fa-save"></i>
          Generar Venta
        </button>
      </div>

    </div>
  </div>
</form>